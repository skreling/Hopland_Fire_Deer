---
title: "MCP Generation"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This script creates MCP centroids for all deer pre and post fire

```{r}
packages <- c('adehabitatHR','adehabitatLT','lubridate','plyr','rgeos','here','rgdal', 'sp', 'dplyr','raster','proxy','tibble','stringr')

install_load <- function(packages){
     for (p in packages) {
          if (p %in% rownames(installed.packages())) {
               library(p, character.only=TRUE)
          } else {
               install.packages(p)
               library(p,character.only = TRUE)
          }
     }
}

install_load(packages)
```

# Pre-fire Deer MCP and Centroids

## Pre-fire
```{r}
# This script was used to generate MCPs
prefire <- read.csv(here::here("Publication_Data","Collars","deer-gps-prefire.csv")) #load in pre-fire dataframe

# Create SPDF
prefire.spdf <- SpatialPointsDataFrame(coords=as.data.frame(cbind(prefire$Easting, prefire$Northing)), 
                                       data=prefire,
                                       proj4string=CRS("+proj=utm +zone=10 ellps=WGS84")) #create spatial points dataframe

# Calculate MCP
prefire.mcp <- mcp(prefire.spdf[,"AnimalID"], percent=95, unin="m", unout="km2") # create 95% mcp for each animal in km^2
plot(prefire.mcp, col=c(1:length(unique(prefire$AnimalID))))  #show plot of all deer mcps

trueCentroidsPre <- as.data.frame(gCentroid(prefire.mcp, byid=TRUE)) # get centroid of each mcp
trueCentroidsPre$Time <- 'Pre'
```

## Post-fire
```{r}
postfire <- read.csv(here::here("Publication_Data","Collars","deer-gps-postfire.csv")) #load in pre-fire dataframe

# Remove J3 'during fire' points from home range analysis (due to high displacement) 
postfire <- postfire[-c(5715:5768),]

# Create SPDF
postfire.spdf <- SpatialPointsDataFrame(coords=as.data.frame(cbind(postfire$Easting, postfire$Northing)), 
                                       data=postfire,
                                       proj4string=CRS("+proj=utm +zone=10 ellps=WGS84")) #create spatial points dataframe

# Calculate MCP
postfire.mcp <- mcp(postfire.spdf[,"AnimalID"], percent=95, unin="m", unout="km2") # create 95% mcp for each animal in km^2
plot(postfire.mcp, col=c(1:length(unique(postfire$AnimalID))))  #show plot of all deer mcps

trueCentroidsPost <- as.data.frame(gCentroid(postfire.mcp, byid=TRUE)) # get centroid of each mcp
trueCentroidsPost$Time <- 'Post'
```


# All Centroids
Merge all centroids to create dataframe of centroid locations
```{r}
all.centroids <- bind_rows(trueCentroidsPre, trueCentroidsPost) # combine the 2 dataframes
all.centroids <- all.centroids[order(rownames(all.centroids)),] #order by rowname (animal id)
all.centroids <- all.centroids[order(all.centroids$Time),]# order by time period

# create column for ID - requires some weird formatting fixes
all.centroids$AnimalID <- row.names(all.centroids)
all.centroids$AnimalID <- substr(all.centroids$AnimalID, start = 1, stop = 2)

# fix the three-character deer
all.centroids$AnimalID <- as.factor(all.centroids$AnimalID)
levels(all.centroids$AnimalID)[levels(all.centroids$AnimalID)=="A5"] ="A5b"
levels(all.centroids$AnimalID)[levels(all.centroids$AnimalID)=="D3"] ="D3b"

head(all.centroids)
#write.csv(all.centroids, here::here('Publication_Data','Collars','MCP_Centroid.csv'), row.names = F)
```
